import os
import re

__api = {}


def run(decode_path):
	__api.clear()
	__api_extract(decode_path)
	return __api
	pass


def __api_extract(decode_path):
	smali_path = decode_path + '/smali/'
	# bfs
	for path1 in os.listdir(smali_path):
		if path1 != 'android':
			stack = list()
			full_path = os.path.join(smali_path, path1)
			if os.path.isdir(full_path):
				stack.append(full_path)
			else:
				__regular(full_path)
			# dfs
			while len(stack) > 0:
				tmp = stack.pop()
				for path in os.listdir(tmp):
					next_path = os.path.join(tmp, path)
					if os.path.isdir(next_path):
						stack.append(next_path)
					else:  # all .smali file
						__regular(next_path)


def __regular(file_path):
	f = open(file_path, 'r')
	content = f.read()
	str_list = re.findall('invoke[^\n]*Landroid[^\n]*->[^\n]*', content)
	for item in str_list:
		#  lib
		start = item.find('Landroid')
		end = item.find('->')
		lib_str = item[start + 1:end - 1]
		lib_str = lib_str.replace('/', '.')
		lib_str = lib_str.replace('$', '.')
		# function
		function_str = re.search('->\w+\(', item[end::])
		if function_str:
			fun_name = function_str.group()[2:-1] + '()'
			if __api.get(lib_str) is None:
				__api[lib_str] = {}
				__api[lib_str][fun_name] = 1
			else:
				if __api[lib_str].get(fun_name) is None:
					__api[lib_str][fun_name] = 1
				else:
					__api[lib_str][fun_name] += 1
	f.close()
