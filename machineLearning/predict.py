import os
import pickle
from infoExtract import permission, api
import numpy as np


def run(filename, out_path):
	decode_path = os.path.join(out_path, filename[:-4])
	cmd = 'apktool d ' + out_path + filename + ' -o ' + decode_path;
	os.system(cmd)  # decode apk
	if os.path.exists(os.path.join(decode_path, "AndroidManifest.xml")) is not True:
		return "该应用设有防止反编译机制，无法反编译，请换一个应用"
	all_permission = permission.run(decode_path)  # return all permission needed
	all_api = api.run(decode_path)  # return all api called
	''' 预测
	'''
	model = pickle.load(open('dataset/model', 'rb'))
	permission_coding = pickle.load(open('dataset/permission_coding', 'rb'))
	feature_vector = np.zeros(len(permission_coding))
	for key in all_permission:
		if permission_coding.get(key):
			feature_vector[permission_coding[key]] = 1
	expect = model.predict(feature_vector)
	if expect == 1:
		result = "预测该应用是 恶意应用"
	else:
		result = "预测该应用是 良性应用"
	return all_permission, all_api, result
