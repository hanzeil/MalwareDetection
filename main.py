import os

from flask import Flask, request, redirect, url_for, render_template
from werkzeug import secure_filename

from infoExtract import permission, api
from machineLearning import feature_matrix, decode, ml

UPLOAD_FOLDER = '/srv/http/uploads/'
ALLOWED_EXTENSIONS = set(['apk'])

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
apks_path = "/srv/http/apks/"


def allowed_file(filename):
	return '.' in filename and filename.rsplit('.', 1)[1] in ALLOWED_EXTENSIONS


@app.route('/', methods=['GET'])
def index():
	return render_template('index.html')


@app.route('/', methods=['POST'])
def upload():
	if request.files.get('file'):
		file = request.files['file']
		if file and allowed_file(file.filename):
			filename = secure_filename(file.filename)
			file.save(os.path.join(app.config['UPLOAD_FOLDER'], filename))
			return redirect(url_for('uploaded_file', filename=filename))
	elif request.values.get('apks_path'):
		global apks_path
		apks_path = request.values.get('apks_path')
		return redirect(url_for('decoding'))
	elif request.values.get('permission'):
		return redirect(url_for('permission'))
	elif request.values.get('api'):
		return '搭建中'
	elif request.values.get('training'):
		return redirect(url_for('training'))
	return 'Error 400 Bad Request'


@app.route('/uploads/<filename>')
def uploaded_file(filename):
	out_path = app.config['UPLOAD_FOLDER']
	decode_path = out_path + filename.rsplit('.', 1)[0]
	cmd = 'apktool d ' + out_path + filename + ' -o ' + decode_path;
	os.system(cmd)  # decode apk
	all_permission = permission.run(decode_path)  # return all permission needed
	all_api = api.run(decode_path)  # return all api called
	return render_template('result.html', allpermission=all_permission, allapi=all_api)


@app.route('/decoding/')
def decoding():
	decode.run(apks_path)
	return render_template('index.html',docoded=True)


@app.route('/permission/')
def permission():
	feature_matrix.permission(apks_path)
	return "权限特征提取完成"

@app.route('/training')
def training():
	ml.run()
	return '训练结束'


if __name__ == '__main__':
	app.debug = True
	app.run(host='0.0.0.0')
