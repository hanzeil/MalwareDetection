import os

from flask import Flask, request, redirect, url_for, render_template

from machineLearning import feature_matrix, decode, ml, predict

UPLOAD_FOLDER = '/srv/http/uploads/'
ALLOWED_EXTENSIONS = set(['apk', 'APK'])

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
apks_path = "/srv/http/apks/"


def allowed_file(filename):
	return '.' in filename and filename.rsplit('.', 1)[1] in ALLOWED_EXTENSIONS


@app.route('/', methods=['GET'])
def index():
	return render_template('index.html', apks_path=apks_path)


@app.route('/', methods=['POST'])
def upload():
	if request.files.get('file'):
		file = request.files['file']
		if file and allowed_file(file.filename):
			file.save(os.path.join(app.config['UPLOAD_FOLDER'], file.filename))
			return redirect(url_for('uploaded_file', filename=file.filename))
		return "上传文件必须为APK"
	elif request.values.get('apks_path'):
		global apks_path
		apks_path = request.values.get('apks_path')
		print(apks_path)
		return render_template('index.html', apks_path=apks_path)
	elif request.values.get('decoding'):
		return redirect(url_for('decoding'))
	elif request.values.get('per_extract'):
		return redirect(url_for('per_extract'))
	elif request.values.get('api'):
		return '搭建中'
	elif request.values.get('training'):
		return redirect(url_for('training'))
	return 'Error 400 Bad Request'


@app.route('/uploads/<filename>')
def uploaded_file(filename):
	all_permission, all_api, result = predict.run(filename, app.config['UPLOAD_FOLDER'])
	return render_template('result.html', allpermission=all_permission, allapi=all_api, result=result)


@app.route('/decoding/')
def decoding():
	decode.run(apks_path)
	return render_template('index.html')


@app.route('/per_extract/')
def per_extract():
	feature_matrix.permission(apks_path)
	return "权限特征提取完成"


@app.route('/training')
def training():
	ml.train()
	return '训练结束'


if __name__ == '__main__':
	app.debug = True
	app.run(host='0.0.0.0')
